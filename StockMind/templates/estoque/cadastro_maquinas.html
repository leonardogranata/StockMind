{% extends "base.html" %}
{% block content %}


<div class="maquina-container">
    <div class="maquina-card">
      <a href="{% url 'maquinas' %}" class="btn-back">‚Üê Voltar para lista</a>
  
      <h1 class="maquina-title">Cadastrar Nova M√°quina</h1>
      <p class="maquina-subtitle">Preencha os dados para adicionar uma m√°quina ao sistema</p>
  
      <form method="POST" class="maquina-form">
        {% csrf_token %}
      <div class="maquina-grid">
        <div class="maquina-group">
          <label class="maquina-label">C√≥digo</label>
          <input type="text" name="codigo" class="maquina-input" required placeholder="Ex: MQ-001">
        </div>
        <div class="maquina-group">
          <label class="maquina-label">Data de Aquisi√ß√£o</label>
          <input type="date" name="data_aquisicao" class="maquina-input">
        </div>
      </div>

      <div class="maquina-group">
        <label class="maquina-label">Nome da M√°quina</label>
        <input type="text" name="nome" class="maquina-input" required placeholder="Ex: Torno CNC Modelo X">
      </div>

      <div class="maquina-group full">
        <label class="maquina-label">Descri√ß√£o</label>
        <textarea name="descricao" class="maquina-textarea"></textarea>
      </div>

      <div class="maquina-grid">
        <div class="maquina-group">
          <label class="maquina-label">Localiza√ß√£o</label>
          <input type="text" name="localizacao" class="maquina-input" placeholder="Ex: Galp√£o A - Setor 3">
        </div>
        <div class="maquina-group">
          <label class="maquina-label">Status</label>
          <select name="status" class="maquina-select">
            <option value="Ativa">‚úÖ Ativa</option>
            <option value="Em manuten√ß√£o">üîß Em manuten√ß√£o</option>
            <option value="Inativa">‚õî Inativa</option>
          </select>
        </div>
      </div>

      <div class="maquina-group full">
        <label class="maquina-label">Pe√ßas Associadas</label>
        <div class="maquina-multiselect">
          <div class="maquina-selected-items" id="maquina-selected-text">Selecione as pe√ßas</div>
          <div class="maquina-options-list" id="maquina-options-list">
            {% for peca in pecas %}
              <label class="maquina-option-item">
                <input type="checkbox" name="pecas" value="{{ peca.id }}" {% if peca in maquina.pecas.all %}checked{% endif %}>
                {{ peca.nome }}
              </label>
            {% endfor %}
          </div>
        </div>
      </div>

      <button type="submit" class="maquina-submit">Cadastrar M√°quina</button>
    </form>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Seletores compat√≠veis com o HTML que voc√™ postou
        const selectedBox = document.getElementById("maquina-selected-text");
        const optionsList = document.getElementById("maquina-options-list");
        const multiselectWrap = document.querySelector(".maquina-multiselect");
    
        // Se n√£o existir (por alguma raz√£o), sai sem quebrar a p√°gina
        if (!selectedBox || !optionsList || !multiselectWrap) {
            console.warn("Multiselect: elementos n√£o encontrados. Verifique IDs/classes.");
            return;
        }
    
        const checkboxes = optionsList.querySelectorAll("input[type='checkbox']");
    
        // Toggle do dropdown
        selectedBox.addEventListener("click", (e) => {
            e.stopPropagation(); // evita fechar por clique no document
            optionsList.style.display = optionsList.style.display === "block" ? "none" : "block";
        });
    
        // Atualiza texto quando mudar sele√ß√£o
        function updateSelectedText() {
            const selected = Array.from(checkboxes)
                .filter(c => c.checked)
                .map(c => c.parentNode.textContent.trim());
            selectedBox.textContent = selected.length ? selected.join(", ") : "Selecione as pe√ßas";
        }
    
        checkboxes.forEach(chk => chk.addEventListener("change", updateSelectedText));
    
        // Inicializa texto
        updateSelectedText();
    
        // Fecha menu ao clicar fora
        document.addEventListener("click", (e) => {
            if (!e.target.closest(".maquina-multiselect")) {
                optionsList.style.display = "none";
            }
        });
    
        // Evita que o clique nas op√ß√µes feche o menu imediatamente (por bubbling)
        optionsList.addEventListener("click", (e) => {
            e.stopPropagation();
        });
    });
    </script>
{% endblock content %}
