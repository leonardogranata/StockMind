{% extends "base.html" %}

{% block content %}
<h1 class="titulo-previsao-main">Previs√£o de Consumo por Item</h1>

<div class="container-previsao">
    <div class="content-previsao">
        <div class="form-group-select">
            <label for="itemSelect">Selecione um Item:</label>
            <select class="select-customizado" id="itemSelect">
                <option selected disabled>Escolha um item para ver a previs√£o</option>
                {% for nome in nomes_itens %}
                    <option value="{{ nome }}">{{ nome }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="chartContainer" class="chart-wrapper">
            <h3 id="chartTitle" class="chart-title"></h3>
            <canvas id="graficoItem"></canvas>

            <!-- Caixa de sugest√£o -->
            <div id="sugestaoBox" class="sugestao-box" 
                style="margin-top:20px; padding:15px; border-radius:10px; font-size:1.1em; font-weight:500; 
                       transition: all 0.4s ease; opacity:0;">
                <span id="iconeSugestao" style="margin-right:10px;"></span>
                <span id="textoSugestao"></span>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const todasAsPrevisoes = JSON.parse('{{ previsoes_json|escapejs }}');
    const sugestoes = JSON.parse('{{ sugestoes_json|escapejs }}');
    const selectElement = document.getElementById('itemSelect');
    const chartContainer = document.getElementById('chartContainer');
    const chartTitle = document.getElementById('chartTitle');
    const ctx = document.getElementById('graficoItem').getContext('2d');
    const sugestaoBox = document.getElementById('sugestaoBox');
    const iconeSugestao = document.getElementById('iconeSugestao');
    const textoSugestao = document.getElementById('textoSugestao');

    let meuGrafico;

    selectElement.addEventListener('change', function() {
        const itemSelecionado = this.value;
        const dadosDoItem = todasAsPrevisoes[itemSelecionado];
        const mensagem = sugestoes[itemSelecionado] || "Sem sugest√£o dispon√≠vel para este item.";

        // Define cor e √≠cone conforme a mensagem
        let corFundo = '';
        let icone = '';

        if (mensagem.includes("abaixo do n√≠vel m√≠nimo") || mensagem.includes("Compre imediatamente")) {
            corFundo = '#ff4d4d'; // vermelho
            icone = '‚ö†Ô∏è';
        } else if (mensagem.includes("n√≠vel m√≠nimo") || mensagem.includes("nova compra logo") || mensagem.includes("atingir o n√≠vel m√≠nimo")) {
            corFundo = '#ffcc00'; // amarelo
            icone = 'üü°';
        } else if (mensagem.includes("baixo consumo") || mensagem.includes("Evite")) {
            corFundo = '#3b82f6'; // azul
            icone = 'üí§';
        } else if (mensagem.includes("equilibrado")) {
            corFundo = '#22c55e'; // verde
            icone = '‚úÖ';
        } else {
            corFundo = '#6b7280'; // cinza neutro
            icone = '‚ÑπÔ∏è';
        }

        // Atualiza o conte√∫do da sugest√£o
        iconeSugestao.textContent = icone;
        textoSugestao.textContent = mensagem;
        sugestaoBox.style.backgroundColor = corFundo;
        
        // Anima√ß√£o leve de apari√ß√£o
        sugestaoBox.style.opacity = 0;
        setTimeout(() => {
            sugestaoBox.style.opacity = 1;
        }, 100);

        // Atualiza o gr√°fico
        if (dadosDoItem) {
            chartContainer.classList.add('visible');
            atualizarGrafico(itemSelecionado, dadosDoItem);
        } else {
            chartContainer.classList.remove('visible');
        }
    });

    function atualizarGrafico(nomeItem, dados) {
        if (meuGrafico) {
            meuGrafico.destroy();
        }

        const labels = dados.map(dado => dado[0]);
        const valores = dados.map(dado => dado[1]);

        chartTitle.innerText = `Evolu√ß√£o do Consumo Previsto para ${nomeItem}`;

        meuGrafico = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Consumo Previsto',
                    data: valores,
                    borderColor: '#7289da',
                    backgroundColor: 'rgba(114, 137, 218, 0.2)',
                    fill: true,
                    tension: 0.1,
                    borderWidth: 2,
                    pointBackgroundColor: '#7289da',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#ddd' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#ddd' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#ddd' }
                    }
                }
            }
        });
    }
});
</script>
{% endblock content %}
