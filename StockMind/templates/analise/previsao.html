{% extends "base.html" %}

{% block content %}
<h1 class="titulo-previsao-main">Previsão de Consumo por Item</h1>

<div class="container-previsao">
    <div class="content-previsao">
        <div class="form-group-select">
            <label for="itemSelect">Selecione um Item:</label>
            <select class="select-customizado" id="itemSelect">
                <option selected disabled>Escolha um item para ver a previsão</option>
                {% for nome in nomes_itens %}
                    <option value="{{ nome }}">{{ nome }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="chartContainer" class="chart-wrapper">
            <h3 id="chartTitle" class="chart-title"></h3>
            <canvas id="graficoItem"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const todasAsPrevisoes = JSON.parse('{{ previsoes_json|safe }}');
    const selectElement = document.getElementById('itemSelect');
    const chartContainer = document.getElementById('chartContainer');
    const chartTitle = document.getElementById('chartTitle');
    const ctx = document.getElementById('graficoItem').getContext('2d');
    
    let meuGrafico;

    selectElement.addEventListener('change', function() {
        const itemSelecionado = this.value;
        const dadosDoItem = todasAsPrevisoes[itemSelecionado];
        
        if (dadosDoItem) {
            chartContainer.classList.add('visible');
            atualizarGrafico(itemSelecionado, dadosDoItem);
        } else {
            chartContainer.classList.remove('visible');
        }
    });

    function atualizarGrafico(nomeItem, dados) {
        if (meuGrafico) {
            meuGrafico.destroy();
        }

        const labels = dados.map(dado => dado[0]);
        const valores = dados.map(dado => dado[1]);

        chartTitle.innerText = `Evolução do Consumo Previsto para ${nomeItem}`;

        meuGrafico = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Consumo Previsto',
                    data: valores,
                    borderColor: '#7289da',
                    backgroundColor: 'rgba(114, 137, 218, 0.2)',
                    fill: true,
                    tension: 0.1,
                    borderWidth: 2,
                    pointBackgroundColor: '#7289da',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#ddd' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    x: {
                        ticks: { color: '#ddd' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                },
                plugins: {
                    legend: {
                        labels: { color: '#ddd' }
                    }
                }
            }
        });
    }
});
</script>
{% endblock content %}