{% extends "base.html" %}
{% load static %}
{% block title %}StockMind - Editar M√°quina{% endblock title %}
{% block content %}

<div class="maquina-container">
  <div class="maquina-card">
    <a href="{% url 'maquinas' %}" class="btn-back">‚Üê Voltar para lista</a>

    <h1 class="maquina-title">Editar M√°quina</h1>
    <p class="maquina-subtitle">Atualize os dados da m√°quina <strong>{{ maquina.nome }}</strong></p>

    <form method="POST" class="maquina-form">
      {% csrf_token %}

      <div class="maquina-grid">
        <div class="maquina-group">
          <label class="maquina-label">C√≥digo</label>
          <input type="text" name="codigo" class="maquina-input" required value="{{ maquina.codigo }}">
        </div>

        <div class="maquina-group">
          <label class="maquina-label">Data de Aquisi√ß√£o</label>
          <input type="date" name="data_aquisicao" class="maquina-input" value="{{ maquina.data_aquisicao|date:'Y-m-d' }}">
        </div>
      </div>

      <div class="maquina-group">
        <label class="maquina-label">Nome da M√°quina</label>
        <input type="text" name="nome" class="maquina-input" required value="{{ maquina.nome }}">
      </div>

      <div class="maquina-group full">
        <label class="maquina-label">Descri√ß√£o</label>
        <textarea name="descricao" class="maquina-textarea">{{ maquina.descricao }}</textarea>
      </div>

      <div class="maquina-grid">
        <div class="maquina-group">
          <label class="maquina-label">Localiza√ß√£o</label>
          <input type="text" name="localizacao" class="maquina-input" value="{{ maquina.localizacao }}">
        </div>

        <div class="maquina-group">
          <label class="maquina-label">Status</label>
          <select name="status" class="maquina-select">
            <option value="Ativa" {% if maquina.status == "Ativa" %}selected{% endif %}>‚úÖ Ativa</option>
            <option value="Em manuten√ß√£o" {% if maquina.status == "Em manuten√ß√£o" %}selected{% endif %}>üîß Em manuten√ß√£o</option>
            <option value="Inativa" {% if maquina.status == "Inativa" %}selected{% endif %}>‚õî Inativa</option>
          </select>
        </div>
      </div>

      <div class="maquina-group full">
        <label class="maquina-label">Pe√ßas Associadas</label>
        <div class="maquina-multiselect">
          <div class="maquina-selected-items" id="maquina-selected-text">Selecione as pe√ßas</div>
          <div class="maquina-options-list" id="maquina-options-list">
            {% for peca in pecas %}
              <label class="maquina-option-item">
                <input type="checkbox" name="pecas" value="{{ peca.id }}" {% if peca in maquina.pecas.all %}checked{% endif %}>
                {{ peca.nome }}
              </label>
            {% endfor %}
          </div>
        </div>
      </div>

      <button type="submit" class="maquina-submit">Salvar Altera√ß√µes</button>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const selectedBox = document.getElementById("maquina-selected-text");
  const optionsList = document.getElementById("maquina-options-list");
  const multiselectWrap = document.querySelector(".maquina-multiselect");

  if (!selectedBox || !optionsList || !multiselectWrap) return;

  const checkboxes = optionsList.querySelectorAll("input[type='checkbox']");

  selectedBox.addEventListener("click", (e) => {
    e.stopPropagation();
    optionsList.style.display = optionsList.style.display === "block" ? "none" : "block";
  });

  function updateSelectedText() {
    const selected = Array.from(checkboxes)
      .filter(c => c.checked)
      .map(c => c.parentNode.textContent.trim());
    selectedBox.textContent = selected.length ? selected.join(", ") : "Selecione as pe√ßas";
  }

  checkboxes.forEach(chk => chk.addEventListener("change", updateSelectedText));
  updateSelectedText();

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".maquina-multiselect")) optionsList.style.display = "none";
  });

  optionsList.addEventListener("click", (e) => e.stopPropagation());
});
</script>

{% endblock content %}
